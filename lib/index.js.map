{"version":3,"sources":["../src/index.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAM,SAAS,+BAAkB,MAAlB,CAAT;;IAEe;;;;;;;;;AACjB,aADiB,WACjB,GAAc;8BADG,aACH;;2EADG,yBACH;;AAEV,cAAK,UAAL,GAAkB,EAAlB,CAFU;AAGV,cAAK,OAAL,GAAe,OAAO,MAAP,mBAAf,CAHU;;KAAd;;iBADiB;;;;;8BAWb,IAAI;AACJ,mBAAO,KAAP,CAAa,KAAb,EAAoB,EAAE,MAAM,GAAG,IAAH,IAAW,GAAX,EAA5B,EADI;AAEJ,iBAAK,UAAL,CAAgB,IAAhB,CAAqB,EAArB,EAFI;AAGJ,mBAAO,IAAP,CAHI;;;;;;;kCAMA,GAAG;AACP,mBAAO,KAAP,CAAa,CAAb,EADO;;;;;;gCAIL;;;AACF,mBAAO,QAAQ,GAAR,CAAY,KAAK,aAAL,CAAZ,CAAgC,IAAhC,CAAqC,YAAM;AAC9C,uBAAO,OAAK,aAAL,CADuC;;AAG9C,oBAAI,CAAC,OAAK,SAAL,CAAe,OAAf,EAAwB,MAAxB,EAAgC;AACjC,2BAAK,EAAL,CAAQ,OAAR,EAAiB,OAAK,OAAL,CAAjB,CADiC;iBAArC;;AAIA,uBAAK,QAAL,GAAgB,uBAAQ,OAAK,UAAL,CAAxB,CAP8C;aAAN,CAA5C,CADE;;;;;;;+BAYD,KAAK;;;AACN,mBAAO,KAAP,CAAa,MAAb,EAAqB,EAAE,QAAF,EAArB,EADM;;AAGN,gBAAI,IAAI,UAAJ,CAAe,GAAf,CAAJ,EAAyB;AACrB,sBAAM,OAAO,QAAP,CAAgB,QAAhB,GAA2B,GAA3B,CADe;aAAzB;;AAIA,iBAAK,OAAL,CAAa,IAAb,GAAoB,GAApB,CAPM;AAQN,iBAAK,QAAL,CAAc,IAAd,CAAmB,KAAK,OAAL,CAAnB,CACK,IADL,CACU;uBAAM,QAAQ,IAAR,CAAa,OAAK,OAAL;aAAnB,CADV,CAEK,KAFL,CAEW,UAAC,GAAD;uBAAS,OAAK,IAAL,CAAU,OAAV,EAAmB,GAAnB;aAAT,CAFX,CARM;;;;;;8BA1BQ;AACd,mBAAO,KAAK,GAAL,CADO;;;;WAPD;;;;;;;;AA+CrB,SAAS,OAAT,GAAmB;;AAEf,QAAI,KAAK,OAAL,KAAiB,KAAjB,EAAwB;AACxB,eADwB;KAA5B;;AAIA,QAAI,CAAC,KAAK,QAAL,EAAe,OAApB;;AAEA,QAAI,OAAO,KAAK,IAAL;;;AARI,QAWX,OAAO,IAAP,KAAgB,QAAhB,EAA0B;AAC1B,iBAAS,IAAT,CAAc,SAAd,GAA0B,IAA1B,CAD0B;AAE1B,eAF0B;KAA9B;;AAKA,QAAI,KAAK,QAAL,EAAe;AACf,iBAAS,IAAT,CAAc,SAAd,GAA0B,EAA1B,CADe;AAEf,iBAAS,IAAT,CAAc,WAAd,CAA0B,IAA1B,EAFe;KAAnB;;AAKA,UAAM,IAAI,KAAJ,CAAU,qBAAV,CAAN,CArBe;CAAnB","file":"index.js","sourcesContent":["import { ConsoleLogger } from 'nightingale';\nimport { EventEmitter } from 'events';\nimport compose from './compose';\nimport context from './context';\n\nconst logger = new ConsoleLogger('ibex');\n\nexport default class Application extends EventEmitter {\n    constructor() {\n        super();\n        this.middleware = [];\n        this.context = Object.create(context);\n    }\n\n    get environment() {\n        return this.env;\n    }\n\n    use(fn) {\n        logger.debug('use', { name: fn.name || '-' });\n        this.middleware.push(fn);\n        return this;\n    }\n\n    onerror(e) {\n        logger.error(e);\n    }\n\n    run() {\n        return Promise.all(this._initPromises).then(() => {\n            delete this._initPromises;\n\n            if (!this.listeners('error').length) {\n                this.on('error', this.onerror);\n            }\n\n            this.callback = compose(this.middleware);\n        });\n    }\n\n    load(url) {\n        logger.debug('load', { url });\n\n        if (url.startsWith('?')) {\n            url = window.location.pathname + url;\n        }\n\n        this.context.path = url;\n        this.callback.call(this.context)\n            .then(() => respond.call(this.context))\n            .catch((err) => this.emit('error', err));\n    }\n}\n\nfunction respond() {\n    // allow bypassing\n    if (this.respond === false) {\n        return;\n    }\n\n    if (!this.writable) return;\n\n    let body = this.body;\n    // let code = this.status;\n\n    if (typeof body === 'string') {\n        document.body.innerHTML = body;\n        return;\n    }\n\n    if (body.nodeType) {\n        document.body.innerHTML = '';\n        document.body.appendChild(body);\n    }\n\n    throw new Error('Invalid body result');\n}\n"]}